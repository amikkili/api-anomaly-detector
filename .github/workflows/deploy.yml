name: Deploy API Anomaly Detector

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  test:
    name: Validate Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate imports
        run: |
          python -c "
          import pickle, os, numpy, fastapi, uvicorn
          print('All imports successful')
          print('NumPy version:', numpy.__version__)
          "

      - name: Retrain model in CI environment
        run: |
          python simulator/generate_logs.py
          python training/feature_engineering.py
          python training/train_model.py

      - name: Validate model loads and predicts
        run: |
          python -c "
          import pickle, numpy as np
          with open('serving/model/isolation_forest.pkl', 'rb') as f:
              model = pickle.load(f)
          with open('serving/model/scaler.pkl', 'rb') as f:
              scaler = pickle.load(f)
          X = np.array([[2, 185.0, 22.4, 0, 0, 178.5, 0.0, 20.1, 6.8, 14, 1]])
          X_scaled = scaler.transform(X)
          pred = model.predict(X_scaled)
          print('Prediction:', pred[0])
          print('Model validation passed!')
          "

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Trigger Render Deployment
        run: |
          curl -s -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -w "\nHTTP Status: %{http_code}" \
            --fail

      - name: Deployment triggered
        run: echo "Deployment triggered successfully"
```

---

## Critical YAML Rules to Check
```
RULE 1 — "on:" must be at column 0 (no spaces before it)
RULE 2 — No tabs anywhere — only spaces
RULE 3 — "jobs:" must be at column 0
RULE 4 — Indentation must be exactly 2 spaces per level
```

---

## Verify in VS Code Before Pushing

Install the **YAML extension** in VS Code:
```
Extensions → search "YAML" → RedHat YAML → Install